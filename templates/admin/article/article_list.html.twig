{% extends '@XutimCore/admin/base.html.twig' %}

{% block pageTitle %}{{ 'articles'|trans({}, 'admin')|capitalize }}{%
    endblock
%}

{% block pageMenu %}
    <twig:Xutim:Admin:Button
        tag="a"
        variant="nav"
        href="{{ admin_path('admin_article_new') }}"
    >
        <twig:Xutim:Admin:Icon name="article" />
        {{ 'New article'|trans({}, 'admin') }}
    </twig:Xutim:Admin:Button>
{% endblock %}

{% block languageBar %}
    <twig:Xutim:Admin:LanguageContextBar
        class="d-flex justify-content-end align-items-center mb-2"
    />
{% endblock %}

{% block breadcrumbHeader %}
    <twig:Xutim:Admin:Breadcrumbs>
        <li class="breadcrumb-item">Articles</li>
    </twig:Xutim:Admin:Breadcrumbs>
{% endblock %}

{% block body %}
    {% set tagsOptions = [] %}
    {% for tag in fetch_tags() %}
        {%
            set tagsOptions = tagsOptions|merge([{label: tag.label, value: tag.id}])
        %}
    {% endfor %}
    {%
        component 'Xutim:Admin:DataTable' with {
            frameId: 'articles-list',
            pager: articles,
            tableBodyId: 'articles-list-body',
            filter: filter,
            showChips: true,
            columns: [
              {
                key: 'publicationStatus',
                label: 'S'|trans({}, 'admin'),
                sortable: true,
                order: 'publicationStatus',
                filter: {
                  type: 'select',
                  options: [
                    {label: 'Draft'|trans({}, 'admin'), value: 'draft'},
                    {label: 'Published'|trans({}, 'admin'), value: 'published'},
                    {label: 'Scheduled'|trans({}, 'admin'), value: 'scheduled'},
                  ],
                  placeholder: 'Any'|trans({}, 'admin'),
                  minWidth: '180px',
                },
                chip: true,
              },
              {
                key: 'translationStatus',
                label: 'Translation'|trans({}, 'admin'),
                sortable: false,
                filter: {
                  type: 'select',
                  options: [
                    {label: 'Translated'|trans({}, 'admin'), value: 'translated'},
                    {label: 'Missing'|trans({}, 'admin'), value: 'missing'},
                    {label: 'Using fallback'|trans({}, 'admin'), value: 'fallback'},
                  ],
                  placeholder: 'Any'|trans({}, 'admin'),
                  minWidth: '200px',
                },
                chip: {
                  label: 'Translation'|trans({}, 'admin'),
                },
              },
              {
                key: 'title',
                label: 'title'|trans({}, 'admin'),
                sortable: true,
                order: 'title',
                filter: {type: 'text'},
                chip: true,
              },
              {
                key: 'tags',
                label: 'tags'|trans({}, 'admin'),
                sortable: true,
                order: 'tags',
                filter: {
                  type: 'select',
                  options: tagsOptions,
                  placeholder: 'Any'|trans({}, 'admin'),
                  minWidth: '240px',
                },
                chip: true,
              },
              {
                key: 'inNews',
                label: 'In news'|trans({}, 'admin'),
                sortable: true,
                order: 'inNews',
                filter: {
                  type: 'select',
                  options: [
                      {
                          label: 'yes'|trans({}, 'admin'),
                          value: 'true',
                      }, {
                          label: 'no'|trans({}, 'admin'),
                          value: 'false',
                      },
                  ],
                  placeholder: 'Any'|trans({}, 'admin'),
                  minWidth: '240px',
                },
                chip: true,
              },
              {
                key: 'updatedAt',
                label: 'Updated at'|trans({}, 'admin'),
                sortable: true,
                order: 'updatedAt',
                filter: {
                  type: 'select',
                  options: [
                    {label: 'Last 7 days'|trans({}, 'admin'), value: '7'},
                    {label: 'Last 30 days'|trans({}, 'admin'), value: '30'},
                    {label: 'Last 90 days'|trans({}, 'admin'), value: '90'},
                    {label: 'Older than 90 days'|trans({}, 'admin'), value: '90+'},
                  ],
                  placeholder: 'Any'|trans({}, 'admin'),
                  minWidth: '200px',
                },
                chip: true,
              },
              {
                key: 'publishedAt',
                label: 'published at'|trans({}, 'admin'),
                sortable: true,
                order: 'publishedAt',
                filter: {
                  type: 'select',
                  options: [
                    {label: 'Recently published'|trans({}, 'admin'), value: 'recent'},
                    {label: 'Scheduled for future'|trans({}, 'admin'), value: 'scheduled'},
                    {label: 'Never published'|trans({}, 'admin'), value: 'never'},
                  ],
                  placeholder: 'Any'|trans({}, 'admin'),
                  minWidth: '220px',
                },
                chip: true,
              },
            ],
        }
    %}
    {% block body %}
        {% import '@XutimCore/admin/common/badges.html.twig' as badges %}
        {% for article in articles %}
            {%
                set translation = article.translationByLocaleOrFallback(content_context_language(), default_locale)
            %}
            <tr>
                <td>
                    {% if translation.locale == content_context_language() %}
                        {{ badges.publicationStatusBadge(translation) }}
                    {% else %}
                        {{ badges.missingBadge() }}
                    {% endif %}
                </td>
                <td>
                    {% if translation.locale == content_context_language() %}
                        <span class="status status-green">
                            {{ 'Translated'|trans({}, 'admin') }}
                        </span>
                    {% else %}
                        <span class="status status-warning">
                            {{ translation.locale|upper }}
                        </span>
                    {% endif %}
                </td>
                <td class="text-wrap">
                    <twig:Xutim:Admin:Button
                        tag="a"
                        variant="link"
                        href="{{ admin_path('admin_article_show', {id: article.id, _content_locale: content_context.language}) }}"
                        data-turbo-frame="_top"
                        class="mt-1"
                        aria-label="{{ 'show'|trans({}, 'admin') }}"
                    >
                        {%
                            import '@XutimCore/admin/common/translatable.html.twig' as translatable
                        %}

                        {{
                            translatable.titleWithBadge(article, default_locale)
                        }}
                    </twig:Xutim:Admin:Button>
                </td>
                <td>
                    {% for tag in article.tags %}
                        <twig:Xutim:Admin:Tag :color="tag.color">
                            {{
                                tag.translationByLocaleOrAny(content_context_language(), default_locale).name
                            }}
                        </twig:Xutim:Admin:Tag>
                    {% endfor %}
                </td>
                <td>
                    {% set excludeFromNews = false %}
                    {% for tag in article.tags %}
                        {% if tag.excludeFromNews %}
                            {% set excludeFromNews = true %}
                        {% endif %}
                    {% endfor %}
                    {% if excludeFromNews %}
                        <span class="status status-danger">
                            {{ 'no'|trans({}, 'admin') }}
                        </span>
                    {% else %}
                        <span class="status status-green">
                            {{ 'yes'|trans({}, 'admin') }}
                        </span>
                    {% endif %}
                </td>
                <td>
                    <time
                        datetime="{{ translation.updatedAt|date('c') }}"
                        title="{{ translation.updatedAt|format_datetime('long') }}"
                        class="inline-flex flex-col leading-tight text-xs"
                        data-controller="tooltip"
                    >
                        <span>{{ translation.updatedAt|time_ago() }}</span>
                    </time>
                </td>
                <td>
                    {% if translation.isScheduled() and article.scheduledAt %}
                        <time
                            datetime="{{ article.scheduledAt|date('c') }}"
                            title="{{ article.scheduledAt|format_datetime('long') }}"
                            class="inline-flex flex-col leading-tight text-xs"
                            data-controller="tooltip"
                        >
                            <span>{{
                                article.scheduledAt|time_ago()
                            }}</span>
                        </time>
                    {% elseif translation.publishedAt %}
                        <time
                            datetime="{{ translation.publishedAt|date('c') }}"
                            title="{{ translation.publishedAt|format_datetime('long') }}"
                            class="inline-flex flex-col leading-tight text-xs"
                            data-controller="tooltip"
                        >
                            <span>{{
                                translation.publishedAt|time_ago()
                            }}</span>
                        </time>
                    {% else %}
                        -
                    {% endif %}
                </td>
            </tr>
        {% endfor %}
    {% endblock %}
    {% endcomponent %}
{% endblock %}
