{% extends '@XutimCore/admin/base.html.twig' %}
{% import '@XutimCore/admin/common/badges.html.twig' as badges %}
{% import '@XutimCore/admin/common/translatable.html.twig' as translatable %}

{% block pageTitle %}
    <twig:Xutim:Admin:Icon name="folder" />
    {%
        set translation = page.translationByLocaleOrDefault(content_context_language())
    %}

    {{ translatable.languageBadge(translation) }}
    {{ translation.title }}
{% endblock %}

{% block languageBar %}
    <twig:Xutim:Admin:LanguageContextBar :entity="page" />
{% endblock %}

{% block breadcrumbHeader %}
    <twig:Xutim:Admin:BreadcrumbsPage :page="page" />
{% endblock %}

{% block publicLink %}
    {% if translation is not same as(null) %}
        <twig:Xutim:Admin:PublicPageLink :contentTranslation="translation" />
    {% else %}
        <twig:Xutim:Admin:PublicPageLink />
    {% endif %}
{% endblock %}

{% block pageMenu %}
    {% if translation is not same as(null) %}
        <twig:Xutim:Admin:Button
            tag="a"
            variant="nav"
            href="{{ admin_path('admin_content_translation_revisions', {id: translation.id}) }}"
        >
            <twig:Xutim:Admin:Icon name="history" class="me-1" />
            {{ 'History'|trans({}, 'admin') }}
        </twig:Xutim:Admin:Button>
    {% endif %}

    <twig:Xutim:Admin:Button
        tag="a"
        variant="nav"
        href="{{ admin_path('admin_page_list', {id: page.id}) }}"
    >
        <twig:Xutim:Admin:Icon name="search" class="me-1" />
        Show
    </twig:Xutim:Admin:Button>

    <twig:Xutim:Admin:Button
        tag="button"
        id="sidebar-toggle"
        variant="nav"
        href="#"
    >
        <twig:Xutim:Admin:Icon name="layout-sidebar-right" class="me-1" />
        Sidebar
    </twig:Xutim:Admin:Button>
{% endblock %}

{% block sidebar %}
    <twig:Xutim:Admin:Sidebar :title="">
        <twig:block name="header">
            <twig:Xutim:Admin:SidebarTabs>
                <twig:Xutim:Admin:SidebarTab target="general-tab">
                    <twig:Xutim:Admin:Button
                        variant="tab"
                        type="a"
                        class="active"
                        data-bs-toggle="tab"
                        href="#general-tab"
                        role="tab"
                        aria-controls="general-tab"
                        aria-selected="true"
                    >
                        {{ 'General'|trans({}, 'admin') }}
                    </twig:Xutim:Admin:Button>
                </twig:Xutim:Admin:SidebarTab>
                {% if translation is not same as(null) %}
                <twig:Xutim:Admin:SidebarTab target="history-tab">
                    <twig:Xutim:Admin:Button
                        variant="tab"
                        type="a"
                        data-bs-toggle="tab"
                        href="#history-tab"
                        role="tab"
                        aria-controls="history-tab"
                        aria-selected="false"
                    >
                        {{ 'History'|trans({}, 'admin') }}
                    </twig:Xutim:Admin:Button>
                </twig:Xutim:Admin:SidebarTab>
                {% endif %}
            </twig:Xutim:Admin:SidebarTabs>
        </twig:block>
        <twig:block name="content">
            <div class="tab-content">
                <div id="general-tab" class="tab-pane active" role="tabpanel">
                    {{
                        include('@XutimCore/admin/page/_page_sidebar.html.twig', {translation: translation, referenceHasChanged: referenceHasChanged})
                    }}
                </div>
                {% if translation is not same as(null) %}
                <div id="history-tab" class="tab-pane" role="tabpanel">
                    <turbo-frame
                        id="sidebar-history"
                        src="{{ admin_path('admin_content_translation_sidebar_history', {id: translation.id}) }}"
                        loading="lazy"
                    >
                        <div class="p-3 text-muted small">{{ 'Loading...'|trans({}, 'admin') }}</div>
                    </turbo-frame>
                </div>
                {% endif %}
            </div>
        </twig:block>
    </twig:Xutim:Admin:Sidebar>
{% endblock %}

{% block body %}
    {% if translation is not null and translation.published %}
    <div data-controller="editing-presence"
         data-editing-presence-heartbeat-url-value="{{ admin_path('admin_content_translation_heartbeat', {id: translation.id}) }}"
         data-editing-presence-stop-url-value="{{ admin_path('admin_content_translation_stop_editing', {id: translation.id}) }}"
         data-editing-presence-mercure-topic-value="{{ mercure('content-translation/' ~ translation.id ~ '/presence') }}"
         data-editing-presence-current-user-id-value="{{ app.user.id }}">
        {{ include('@XutimCore/admin/content_translation/_editing_presence_banner.html.twig') }}
        {{ include('@XutimCore/admin/content_translation/_draft_changed_banner.html.twig') }}
    </div>
    {% endif %}
    {{ include('@XutimCore/admin/content_draft/_draft_banner.html.twig') }}
    {% if not referenceExists %}
    <div class="alert alert-warning mb-3">
        {{ 'Reference translation ({locale}) is missing for this content.'|trans({'{locale}': referenceLocale|upper}, 'admin') }}
    </div>
    {% endif %}
    <div
        data-controller="split-view"
        data-split-view-target="root"
        data-split-view-reference-url-value="{{ referenceTranslation ? admin_path('admin_json_content_translation_show', {id: referenceTranslation.id}) : (page.translations|length > 0 ? admin_path('admin_json_content_translation_show', {id: page.translations|first.id}) : '') }}"
        data-split-view-current-translation-id-value="{{ translation ? translation.id : '' }}"
        class="card mb-3"
        data-split-view-block-codes-value="{{ fetch_block_codes()|json_encode }}"
        data-split-view-tags-value="{{ fetch_tags()|json_encode }}"
        data-split-view-fetch-files-url-value="{{ admin_path('admin_json_file_list') }}"
        data-split-view-fetch-all-files-url-value="{{ admin_path('admin_json_file_all_list') }}"
        data-split-view-fetch-file-url-value="{{ admin_path('admin_json_file_show', {id: ':id:'}) }}"
        data-split-view-fetch-images-url-value="{{ admin_path('admin_json_image_list') }}"
        data-split-view-page-ids-url-value="{{ admin_path('admin_json_page_list') }}"
        data-split-view-article-ids-url-value="{{ admin_path('admin_json_article_list') }}"
        data-split-view-tag-ids-url-value="{{ admin_path('admin_json_tag_list') }}"
        data-split-view-fetch-anchor-snippets-url-value="{{ admin_path('admin_json_snippet_list', {type: 'anchor'}) }}"
        {% if translation %}
        data-split-view-reference-diff-url-value="{{ admin_path('admin_content_translation_reference_diff', {id: translation.id}) }}"
        data-split-view-reference-has-changed-value="{{ referenceHasChanged ? 'true' : 'false' }}"
        {% endif %}
    >
        <div class="card-header d-flex align-items-center justify-content-between">
            <div class="fw-bold">
                {% if translation is null %}
                    Translate into {{ content_context_language()|upper }}
                {% else %}
                    {{ translation.locale|upper }} translation
                {% endif %}
            </div>

            <div class="d-flex align-items-center gap-2">
                <select
                    class="form-select form-select-sm"
                    data-split-view-target="localeSelect"
                    data-action="change->split-view#loadReference"
                    hidden
                >
                    {% for tr in page.translations %}
                        <option
                            value="{{ admin_path('admin_json_content_translation_show', {id: tr.id}) }}"
                            {% if referenceTranslation and referenceTranslation.id == tr.id %}
                                selected
                            {% endif %}
                        >
                            {{ tr.locale|locale_name }}{%
                                if referenceTranslation and referenceTranslation.id == tr.id
                            %}
                                â€” {{
                                    'reference for translations'|trans({}, 'admin')
                                }}{% endif %}
                        </option>
                    {% endfor %}
                </select>

                <twig:Xutim:Admin:Button
                    tag="button"
                    variant="default"
                    class="btn-sm"
                    data-split-view-target="localeSelectClipboard"
                    data-action="split-view#copyAllBlocks"
                    title="{{ 'Copy all blocks'|trans({}, 'admin') }}"
                    hidden
                >
                    <twig:ux:icon name="tabler:clipboard" class="w-3 h-3" />
                </twig:Xutim:Admin:Button>

                <twig:Xutim:Admin:Button
                    tag="button"
                    variant="default"
                    class="btn-sm"
                    data-split-view-target="scrollLockBtn"
                    data-action="split-view#toggleScrollLock"
                    title="{{ 'Toggle reference scroll'|trans({}, 'admin') }}"
                    hidden
                >
                    <span data-split-view-target="scrollLockIconLocked">
                        <twig:ux:icon name="tabler:lock" class="w-3 h-3" />
                    </span>
                    <span data-split-view-target="scrollLockIconUnlocked" class="d-none">
                        <twig:ux:icon name="tabler:lock-open" class="w-3 h-3" />
                    </span>
                </twig:Xutim:Admin:Button>

                <twig:Xutim:Admin:Button
                    tag="button"
                    variant="default"
                    class="text-dark d-flex align-items-center text-nowrap btn-sm"
                    data-action="split-view#toggle"
                    title="{{ 'Toggle split view'|trans({}, 'admin') }}"
                >
                    <span
                        data-split-view-target="iconOn"
                        class="d-flex align-items-center"
                    >
                        <twig:ux:icon
                            name="tabler:columns-2"
                            class="w-3 h-3 me-1"
                        />
                        Split view
                    </span>

                    <span
                        data-split-view-target="iconOff"
                        class="d-none d-flex align-items-center"
                    >
                        <twig:ux:icon
                            name="tabler:columns-1"
                            class="w-3 h-3 me-1"
                        />
                        Single view
                    </span>
                </twig:Xutim:Admin:Button>
            </div>
        </div>

        <div class="card-body p-0">
            <div class="row g-0" data-split-view-target="container">
                <div class="col-12 p-4" data-split-view-target="left">
                    {{
                        include('@XutimCore/admin/content_translation/_form.html.twig', {
                        disableEditing: not is_granted(constant('Xutim\\SecurityBundle\\Security\\UserRoles::ROLE_DEVELOPER')),
                    })
                    }}
                </div>

                <div
                    class="col-12 col-lg-6 border-start d-none p-4"
                    data-split-view-target="right"
                >
                    {% if referenceHasChanged %}
                    <div class="alert alert-warning d-flex align-items-center justify-content-between mb-3"
                         data-split-view-target="changedBanner">
                        <div>
                            <twig:ux:icon name="tabler:alert-triangle" class="w-4 h-4 me-2" />
                            {{ 'Reference has changed since your last save'|trans({}, 'admin') }}
                        </div>
                        <twig:Xutim:Admin:Button
                            tag="button"
                            variant="warning"
                            class="btn-sm"
                            data-split-view-target="diffToggleBtn"
                            data-action="split-view#toggleDiff"
                        >
                            <span data-split-view-target="diffToggleBtnShowText">
                                {{ 'Show changes'|trans({}, 'admin') }}
                            </span>
                            <span data-split-view-target="diffToggleBtnHideText" class="d-none">
                                {{ 'Show current'|trans({}, 'admin') }}
                            </span>
                        </twig:Xutim:Admin:Button>
                    </div>
                    {% endif %}

                    <div data-split-view-target="diffContainer" class="d-none"></div>

                    <div data-split-view-target="referenceContainer">
                        <div class="mb-3">
                            <span class="badge bg-primary-lt">
                                {{ referenceLocale|upper }}
                            </span>
                            <span class="text-muted small ms-2">{{ 'Reference'|trans({}, 'admin') }}</span>
                        </div>

                        <div class="mb-3">
                            <div class="text-muted small">{{ 'Intro title'|trans({}, 'admin') }}</div>
                            <div data-split-view-target="metaPretitle">{{ referenceTranslation ? referenceTranslation.pretitle : '' }}</div>
                        </div>

                        <div class="mb-3">
                            <div class="text-muted small">{{ 'Title'|trans({}, 'admin') }}</div>
                            <div class="fw-semibold" data-split-view-target="metaTitle">{{ referenceTranslation ? referenceTranslation.title : '' }}</div>
                        </div>

                        <div class="mb-3">
                            <div class="text-muted small">{{ 'Subtitle'|trans({}, 'admin') }}</div>
                            <div data-split-view-target="metaSubtitle">{{ referenceTranslation ? referenceTranslation.subtitle : '' }}</div>
                        </div>

                        <div class="mb-3">
                            <div class="text-muted small">{{ 'Slug'|trans({}, 'admin') }}</div>
                            <code data-split-view-target="metaSlug">{{ referenceTranslation ? referenceTranslation.slug : '' }}</code>
                        </div>

                        <div class="mb-4">
                            <div class="text-muted small">{{ 'Description'|trans({}, 'admin') }}</div>
                            <div class="text-secondary" data-split-view-target="metaDescription">{{ referenceTranslation ? referenceTranslation.description|striptags : '' }}</div>
                        </div>

                        <div class="ms-4 mt-3">
                            <div
                                id="reference-editor"
                                data-split-view-target="reference"
                            >
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {%
            if not translation and page.translations|length > 0 and form.slug.vars.value is empty
        %}
            {{
                include('@XutimCore/admin/page_translation/new_translation_modal.html.twig', {page: page})
            }}
        {% endif %}
    </div>
{% endblock %}
